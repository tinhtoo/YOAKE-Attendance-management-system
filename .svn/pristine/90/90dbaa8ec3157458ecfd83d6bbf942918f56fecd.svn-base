//***** table header add *****//
function hh() {
    var header = '<tr class="d_head" ><th scope="col">部門コード</th><th scope="col">部門名</th><th scope="col">行削除</th></tr>';
    $(".gvDept").append(header);
}

var count = 0;
//***** table row add *****//
function hh_2() {
    count++;
    var html_input = '<tr class="data"><td ><input tabindex="4" class="dep_id" name="record_' + (count) + ' " style="width: 55px;" type="text" maxlength="6" value=""></td><td><input tabindex="4" style="width: 270px;" type="text" maxlength="20" value=""></td><td><input tabindex="4" class="DeleteRow" name="del-col" type="button" value="削除"></td></tr>';

    $(".gvDept").append(html_input);

}

//***** テーブル行追加ボタン処理 *****//
let lineNo = 0;
$(document).on('click', '#AddNewRow', function() {
    if ($(".d_head")[0]) {
        hh_2()
    } else {
        hh()
        hh_2()
    }

})
lineNo++;


//***** 行削除ボタン処理 *****//
$(".gvDept").on("click", ".DeleteRow", function() {

    if ($(".data")[1]) {
        $(this).closest('.data').remove();
    } else {
        $(this).closest('.data').remove();
        $(".d_head").remove();
    }

});

var popupDept;
//部門情報検索サブ画面
function SearchDept() {
    popupDept = window.open('/search/MT12DeptSearch', '部門情報検索', 'height=550,width=400,left=400,top=90,resizable=yes,scrollbars=yes,toolbar=yes,menubar=no,location=no,directories=no, status=yes');
    window.focus();
    popupDept.focus();
}

//ポップアップ画面を閉じる
window.addEventListener('unload', function(event) {
    if (typeof popupDept != "undefined") {
        popupDept.close();
    }
});

//社員情報検索サブ画面

var popupEmp;
//ポップアップ画面を開く
function SearchEmp() {
    popupEmp = window.open('/search/MT10EmpSearch', '社員情報検索', 'height=650,width=500,left=350,top=90,resizable=yes,scrollbars=yes,toolbar=yes,menubar=no,location=no,directories=no, status=yes');
    window.focus();
    popupEmp.focus();
}

//ポップアップ画面を閉じる
window.addEventListener('unload', function(event) {
    if (typeof popupEmp != "undefined") {
        popupEmp.close();
    }
});

/**
 * 出退勤入力画面詳細枠の表示
 **/

$('#btnDisp').on('click', function() {
    //var table = document.getElementById('#gridview-warp');
    $('#gridview-warp').show('slow');
    $(this).attr('disabled', 'disabled');
});

/* 日プルダウン作成 */
function AddDropDownList(txtYearClientId, ddlMonthClientId, ddlDayClientId) {
    var txtYear = document.getElementById(txtYearClientId);
    var ddlMonth = document.getElementById(ddlMonthClientId);
    var ddlDay = document.getElementById(ddlDayClientId);
    if (txtYear.value.trim().length == 0 || ddlMonth.options[ddlMonth.selectedIndex].value.trim().length == 0) {
        return false;
    }

    var ddlDaySelectIndex = ddlDay.selectedIndex;
    var yearValue = parseInt(txtYear.value);
    var monthValue = parseInt(ddlMonth.options[ddlMonth.selectedIndex].value);
    var nextYearValue;
    var nextMonthValue;
    if (monthValue == 12) {
        nextYearValue = yearValue + 1;
        nextMonthValue = 1;
    } else {
        nextYearValue = yearValue;
        nextMonthValue = monthValue + 1;
    }
    var lastDay = new Date(nextYearValue, nextMonthValue - 1, 0);
    lastDay = lastDay.getDate();
    ddlDay.options.length = 0;
    ddlDay.options[0] = new Option('', '');

    for (index = 1; index <= lastDay; index++) {
        ddlDay.options[index] = new Option(index, index);
    }
    if (ddlDay.options.length <= ddlDaySelectIndex) {
        ddlDay.selectedIndex = ddlDay.options.length - 1;
    } else {
        ddlDay.selectedIndex = ddlDaySelectIndex;
    }
}

$(function() {
    // 部門検索
    var searchedDeptCd = undefined;
    var searchDeptName = function() {
        // レスポンスの出力先が無い場合、何もせず終了
        if (!$('#deptName').length || !$('#deptNameError').length) {
            return false;
        }
        var deptCd = $('#txtDeptCd').val();
        // 変更なしの場合、再検索しない
        if (searchedDeptCd && searchedDeptCd == deptCd) {
            return false;
        }
        $('#deptNameError').empty();
        $('#deptName').prop("disabled", false);
        $('#deptName').val('');
        $('#deptName').prop("disabled", true);

        // 部門コード未入力の場合、初期化のみ検索なし
        if (!deptCd) {
            return false;
        }

        if ($('#DeptCdValidError').length) {
            $('#DeptCdValidError').text('');
        }
        $.get('/search/MT12DeptSearch/' + deptCd, function(data) {
            searchedDeptCd = deptCd;
            if (data.deptName != null) {
                $('#deptName').prop("disabled", false);
                $('#deptName').val(data.deptName);
                $('#deptName').prop("disabled", true);
            } else {
                $('#deptNameError').append(data.errorMessage);
            }
        });
    };
    searchDeptName();
    $('#txtDeptCd').focusout(searchDeptName);

    // 社員検索
    var searchedEmpCd = undefined;
    var searchEmpName = function() {
        // レスポンスの出力先が無い場合、何もせず終了
        if (!$('#empName').length || !$('#EmpCdError').length) {
            return false;
        }
        var empCd = $('#txtEmpCd').val();
        // 変更なしの場合、再検索しない
        if (searchedEmpCd && searchedEmpCd == empCd) {
            return false;
        }

        $('#EmpCdError').empty();
        $('#empName').prop("disabled", false);
        $('#empName').val('');
        $('#empName').prop("disabled", true);
        if ($('#deptName').length) {
            $('#deptName').prop("disabled", false);
            $('#deptName').val('');
            $('#deptName').prop("disabled", true);
        }

        // 社員コード未入力の場合、初期化のみ検索なし
        if (!empCd) {
            return false;
        }

        if ($('#EmpCdValidError').length) {
            $('#EmpCdValidError').text('');
        }
        $.get('/search/MT10EmpSearch/' + empCd, function(data) {
            searchedEmpCd = empCd;
            if (data.empName != null && data.deptName != null) {
                $('#empName').prop("disabled", false);
                $('#empName').val(data.empName);
                $('#empName').prop("disabled", true);
                if ($('#deptName').length) {
                    $('#deptName').prop("disabled", false);
                    $('#deptName').val(data.deptName);
                    $('#deptName').prop("disabled", true);
                }
            } else {
                $('#EmpCdError').append(data.errorMessage);
            }
        });
    };
    searchEmpName();
    $('#txtEmpCd').focusout(searchEmpName);


    // 汎用loading
    loading = function() {
        $.LoadingOverlay("show");
        setTimeout(function() {
            $.LoadingOverlay("hide");
        }, 10000);
    }

    ajaxWithLoading = function(arg) {
        var opt = $.extend({}, $.ajaxSettings, arg);
        var jqXHR = $.ajax(opt);
        var defer = $.Deferred();

        $.LoadingOverlay("show");

        jqXHR.done(function(data, statusText, jqXHR) {
            $.LoadingOverlay("hide");
            defer.resolveWith(this, arguments);
        });

        jqXHR.fail(function(jqXHR, statusText, errorThrown) {
            $.LoadingOverlay("hide");
            if (jqXHR.status == 403) {

            }

            defer.rejectWith(this, arguments);
        });
        jqXHR.always(function() {});

        return $.extend({}, jqXHR, defer.promise());
    };
});