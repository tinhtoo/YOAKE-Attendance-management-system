<?php

namespace App\Repositories\Search;

use Illuminate\Http\Request;
use App\Models\MT11Login;
use App\Models\MT10Emp;
use App\Models\MT12Dept;
use App\Models\MT13DeptAuth;

class MT12DeptSearchRepository
{
    public function dataSearch()
    {
        /* SessionでログインIDの取得 */
        $loginUser = session('id');
        /* ログインIDより社員CD取得 1 */
        $emp_cd = MT11Login::where(['LOGIN_ID' => $loginUser])->pluck('EMP_CD')->first();
        /* ログイン社員の部門権限取得 2 */
        $dept_auth_cd = MT10Emp::where('EMP_CD', $emp_cd)->pluck('DEPT_AUTH_CD')->first();
        /* ログイン社員の権限がある部門の取得 3 */
        $dept_cd = MT13DeptAuth::where('DEPT_AUTH_CD', $dept_auth_cd)->pluck('DEPT_CD')->all();
        /* ログイン社員の部門権限に含まれる部門の取得 4 */
        $query = MT12Dept::whereIn('DEPT_CD',$dept_cd)
        ->where('DISP_CLS_CD', '=', '01')
        ->orderByRaw('DEPT_CD', 'ASC')->paginate(20);
        if ($query->count() <= 0)
        {
            $query = MT12Dept::join('MT10_EMP','MT10_EMP.DEPT_CD','MT12_DEPT.DEPT_CD')
            ->where('MT10_EMP.EMP_CD', $emp_cd)
            ->orderByRaw('MT12_DEPT.DEPT_CD', 'ASC')->paginate(20);
        }
        return $query;
    }
    
    public function getName($input_dept_cd)
    {
        /* SessionでログインIDの取得 */
        $loginUser = session('id');
        /* ログインIDより社員CD取得 1 */
        $emp_cd = MT11Login::where(['LOGIN_ID' => $loginUser])->pluck('EMP_CD')->first();
        /* ログイン社員の部門権限取得 2 */
        $dept_auth_cd = MT10Emp::where('EMP_CD', $emp_cd)->pluck('DEPT_AUTH_CD')->first();
        /* ログイン社員の権限がある部門の取得 3 */
        $dept_cd = MT13DeptAuth::where('DEPT_AUTH_CD', $dept_auth_cd)->pluck('DEPT_CD')->all();
        /* ログイン社員の部門権限に含まれる部門の取得 4 */
        $result = MT12Dept::whereIn('DEPT_CD',$dept_cd)
            ->where('DISP_CLS_CD', '=', '01')
            ->where('DEPT_CD', '=', $input_dept_cd)
            ->pluck('DEPT_NAME')->first();
        return $result;
    }
}
