<?php

namespace App\Http\Requests;

use App\Models\MT99Msg;
use App\Models\MT02CalendarPtn;
use Illuminate\Foundation\Http\FormRequest;
use Illuminate\Validation\Rule;
use Illuminate\Validation\Validator;

class MT02CalendarPtnRequest extends FormRequest
{
    public function rules()
    {
        $rules = [];

        $input_data = $this->request->all();
        $workptn = $input_data['WorkPtn'];
        $exitCheck = MT02CalendarPtn::where(['CALENDAR_CD' => $input_data['CalendarCd']])->exists();
        // $Calendar_Cd = MT02CalendarPtn::where(['CALENDAR_CD' => $input_data['CalendarCd']])->pluck('CALENDAR_CD');
        

        // if ($input_data !='CalendarCd' && $input_data != 'CalendarPtnName'){
        if (empty($input_data['CalendarCd']) || empty($input_data['CalendarPtnName']) || $input_data['CalendarCd'] == '999' || $exitCheck){
            // $Calendar_Cd = MT02CalendarPtn::where(['CALENDAR_CD' => $input_data['CalendarCd']])->get('CALENDAR_CD');
            $rules = [
                    'CalendarCd' => [
                        'required',
                        function ($attribute, $value, $fail) {
                            // チェック２処理（CD-4004）'999は使用できません。'
                            $msg_4004 = MT99Msg::where('MSG_NO', '4004')->pluck('MSG_CONT')->first();
        
                            if($value == '999'){
                                $fail($msg_4004);
                            }
        
                        },
                        function ($attribute, $value, $fail) {
                            $msg_2001 = MT99Msg::where('MSG_NO', '2001')->pluck('MSG_CONT')->first();
                            // チェック３処理（CD-2001）'該当データが存在します。'
                            $exitCheck = MT02CalendarPtn::where(['CALENDAR_CD' => $value])->exists();
                            $requestCd = $this->request->get('CalendarCd');

                            if($exitCheck){
                                $fail($msg_2001);
                            }
                            
                        }
                    ],
                    'CalendarPtnName' => ['required'],
                ];
            return $rules;
        }

        // $input_data = $this->request->all();
        if($workptn = 'rbUsuallyWork' && $workptn != 'rbShiftWork'){
            if (($input_data = 'CalendarCd' || $input_data = 'CalendarPtnName') || $input_data['CalendarCd'] !== '999' || !$exitCheck) {
                //     $exitCheck = MT02CalendarPtn::where(['CALENDAR_CD' => $input_data['CalendarCd']])->exists();
                //     // dd($exitCheck);
                //     dd($input_data['CalendarCd']);
                // if ($input_data['CalendarCd'] !== '999' && $exitCheck == false){    

                    $rules = [
                        'ddlMonWorkPtn' => ['required'],
                        'ddlTueWorkPtn' => ['required'],
                        'ddlWedWorkPtn' => ['required'],
                        'ddlThuWorkPtn' => ['required'],
                        'ddlFriWorkPtn' => ['required'],
                        'ddlSatWorkPtn' => ['required'],
                        'ddlSunWorkPtn' => ['required'],
                        'ddlHldWorkPtn' => ['required'],
                    ];
                    return $rules;
                }
            // }
        }
        return $rules;
    }
    


    public function messages()
    {
        //（CD-2002）'必須入力項目です。'
        $msg_2002 = MT99Msg::where('MSG_NO', '2002')->pluck('MSG_CONT')->first();
        // //（CD-4004）'999は使用できません。'
        // $msg_4004 = MT99Msg::where('MSG_NO', '4004')->pluck('MSG_CONT')->first();
        // //（CD-2001）'該当データが存在します。'
        // $msg_2001 = MT99Msg::where('MSG_NO', '2001')->pluck('MSG_CONT')->first(); 
        return [
            'CalendarCd.required' => $msg_2002,
            // 'CalendarCd.required' => $msg_4004,
            // 'CalendarCd.required' => $msg_2001,
            'CalendarPtnName.required' => $msg_2002,
            'ddlMonWorkPtn.required' => $msg_2002,
            'ddlTueWorkPtn.required' => $msg_2002,
            'ddlWedWorkPtn.required' => $msg_2002,
            'ddlThuWorkPtn.required' => $msg_2002,
            'ddlFriWorkPtn.required' => $msg_2002,
            'ddlSatWorkPtn.required' => $msg_2002,
            'ddlSunWorkPtn.required' => $msg_2002,
            'ddlHldWorkPtn.required' => $msg_2002,
        ];
    }
}

